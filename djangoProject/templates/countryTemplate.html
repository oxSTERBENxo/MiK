{% load static %}
<!DOCTYPE html>
<html lang="mk">
<head>
    <meta charset="UTF-8">
    <title>{{ country.name }} ‚Äì –ú–∏–Ω–∏ –ö–≤–∏–∑</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Comic+Sans+MS&display=swap" rel="stylesheet">
    <link rel="icon" href="{% static '/favicon.ico' %}" type="image/x-icon">
    <style>
        body {
            font-family: 'Comic Sans MS', sans-serif;
            background-image: url('{{ country.background.url }}');
            background-repeat: repeat-y;
            background-size: contain;
            background-position: center top;
            background-attachment: scroll;
            background-color: #fff;
            color: {{ country.color }};
            padding: 40px 20px;
            font-size: 1.4rem;
        }

        @media (max-width: 768px) {
            body { background-size: cover; }
        }

        .quiz-block { max-width: 700px; margin: 0 auto; }

        .btn-softwhite {
            background-color: #f8f8f8;
            color: {{ country.color }};
            border: none;
        }

        .polaroid-box {
            background-color: rgba(255, 255, 255, 0.85);
            padding: 10px;
            border: 2px solid #ccc;
            border-radius: 12px;
            width: 140px;
            text-align: center;
            box-shadow: 2px 2px 10px rgba(0,0,0,0.1);
            transform: rotate(-2deg);
            transition: transform 0.3s ease;
        }
        .polaroid-box:hover { transform: rotate(0deg) scale(1.05); }

        .card-title { font-size: 1.6rem; }
        .form-check-label { font-size: 1.3rem; }
        .polaroid-box p { font-size: 1rem; }

        #popupOverlay { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        @media (max-width: 768px) {
          #popupImage { max-width: 100%; max-height: 50vh; object-fit: contain; }
        }

        .music-toggle-btn {
          position: fixed;
          bottom: 20px;
          right: 20px;
          background-color: rgba(255, 255, 255, 0.85);
          color: {{ country.color }};
          border: 2px solid {{ country.color }};
          padding: 10px 18px;
          border-radius: 30px;
          font-size: 1rem;
          font-weight: bold;
          cursor: pointer;
          z-index: 999;
          transition: all 0.3s ease;
        }
        .music-toggle-btn:hover { background-color: {{ country.color }}; color: white; }

        /* ===== Twemoji helpers (safe even if no flags on this page) ===== */
        .country-emoji{
          font-family: "Segoe UI Emoji","Apple Color Emoji","Noto Color Emoji","Twemoji Mozilla", system-ui, sans-serif;
        }
        .country-emoji img.twemoji-flag{
          width: 1em;
          height: 1em;
          vertical-align: -0.12em;
        }
    </style>
</head>
<body>

<audio id="bg-audio" loop>
  <source src="{{ song.file.url }}" type="audio/mpeg">
</audio>

<button id="musicToggleBtn" class="music-toggle-btn" onclick="toggleMusic()">
  ‚ñ∂Ô∏è –ü—É—à—Ç–∏ –º—É–∑–∏–∫–∞
</button>

<div class="quiz-block text-center mb-5">
    <h1 class="fw-bold py-4 px-5 rounded-4 shadow d-inline-block text-center"
        style="background-color: rgba(255, 255, 255, 0.85); color: {{ country.color }};">
        {{ country.headline }}
    </h1>
</div>

<form id="quizForm" class="mt-4 quiz-block">
    {% for question in questions %}
        <div class="card my-5 shadow-sm rounded-4"
        style="background-color: rgba(255, 255, 255, 0.85); border: 2px solid {{ country.color }};">
            <div class="card-body">
                <h5 class="card-title mb-3 fw-bold" style="color: {{ country.color }};">
                    {{ forloop.counter }}. {{ question.content }}
                </h5>
                {% for choice in question.shuffled_choices %}
                    <div class="form-check">
                        <input type="radio"
                               name="q{{ forloop.parentloop.counter }}"
                               value="{{ choice.is_correct|yesno:'1,0' }}"
                               id="q{{ forloop.parentloop.counter }}-{{ forloop.counter }}"
                               style="accent-color: {{ country.color }};">
                        <label class="form-check-label" for="q{{ forloop.parentloop.counter }}-{{ forloop.counter }}"
                               style="color: {{ country.color }};">
                            {{ choice.content }}
                        </label>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endfor %}

    <div class="text-center mt-4">
        <button type="button" class="btn btn-lg btn-softwhite" onclick="calculateScore()">–ó–∞–≤—Ä—à–∏</button>
    </div>
</form>

<div class="quiz-block">
    <div id="result-box"
         class="alert text-center mt-4 d-none"
         style="background-color: rgba(255, 255, 255, 0.85); border: 2px solid {{ country.color }}; color: {{ country.color }};"
         role="alert">
    </div>
</div>

<div class="container text-center mt-5">
    <a href="https://read.bookcreator.com/" target="_blank" class="btn btn-softwhite">
        ‚¨ÖÔ∏è –í—Ä–∞—Ç–∏ —Å–µ –Ω–∞ –ø—Ä–∏–∫–∞–∑–Ω–∞—Ç–∞
    </a>
</div>

<div class="container mt-5">
  <div class="text-center mb-4">
    <h3 class="d-inline-block px-4 py-2 rounded-4 shadow"
        style="background-color: rgba(255,255,255,0.85); color: {{ country.color }};">
      üì∏ –ì–∞–ª–µ—Ä–∏—ò–∞
    </h3>
  </div>

  <div class="d-flex flex-wrap justify-content-center gap-3" style="margin-top: 40px;">
      {% for photo in polaroids %}
          <div class="polaroid-box">
              <img src="{{ photo.photo.url }}" alt="{{ photo.headline }}"
              onclick="openPopup('{{ photo.photo.url }}', `{{ photo.explanation|default:''|escapejs }}`)"
              style="cursor: zoom-in; width: 100%; aspect-ratio: 1 / 1; object-fit: cover; display: block; border-radius: 6px;">
              <p style="margin-top: 8px; font-size: 14px; color: {{ country.color }};">{{ photo.headline }}</p>
          </div>
      {% endfor %}
  </div>
</div>

<script>
    function calculateScore() {
        let total = 0;
        const questionCount = {{ questions.count }};
        for (let i = 1; i <= questionCount; i++) {
            const selected = document.querySelector(`input[name="q${i}"]:checked`);
            if (selected) total += parseInt(selected.value);
        }
        const resultBox = document.getElementById("result-box");
        resultBox.classList.remove("d-none");
        resultBox.innerHTML =
            total >= questionCount
                ? "üéâ <strong>–ë—Ä–∞–≤–æ!</strong> –û–¥–≥–æ–≤–æ—Ä–∏ —Ç–æ—á–Ω–æ –Ω–∞ —Å–∏—Ç–µ –ø—Ä–∞—à–∞—ö–∞ ‚Äì –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ –ø–æ–∑–Ω–∞–≤–∞—ö–µ –Ω–∞ {{ country.name }}!"
                : "üå∏ –ù–∞—É—á–∏ –Ω–µ—à—Ç–æ –Ω–æ–≤–æ –∏ –ø—Ä–æ–±–∞—ò –ø–∞–∫! –†–µ–∑—É–ª—Ç–∞—Ç: " + total + "/" + questionCount;
    }

    function openPopup(src, caption) {
        const popup = document.getElementById("popupOverlay");
        const img = document.getElementById("popupImage");
        const text = document.getElementById("popupText");

        img.src = src;
        text.textContent = caption || '';
        popup.style.display = "flex";
    }

    function closePopup() {
        const popup = document.getElementById("popupOverlay");
        popup.style.display = "none";
    }

    // Allow ESC key to close popup
    document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape') { closePopup(); }
    });

    const audio = document.getElementById("bg-audio");
    const btn = document.getElementById("musicToggleBtn");

    function toggleMusic() {
      if (audio.paused || audio.ended) {
        audio.muted = false;
        audio.play()
          .then(() => { btn.innerText = "‚è∏Ô∏è"; })
          .catch(err => { console.warn("–ò–º–∞ –ø—Ä–æ–±–ª–µ–º :(", err); });
      } else {
        audio.pause();
        btn.innerText = "‚ñ∂Ô∏è";
      }
    }
</script>

<!-- Popup Modal -->
<div id="popupOverlay" style="
    display: none;
    position: fixed;
    z-index: 1000;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-color: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(3px);
    overflow-y: auto;
    padding: 40px 0;
    box-sizing: border-box;">
  <div style="
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      gap: 20px;
      max-width: 90%;
      margin: 0 auto;
      padding: 20px;
      box-sizing: border-box;">
      <span onclick="closePopup()" style="
          color: white;
          font-size: 2rem;
          position: absolute;
          top: 30px;
          right: 40px;
          cursor: pointer;">‚úñ</span>
      <img id="popupImage" src="" alt="Polaroid" style="
          max-width: 90%;
          max-height: 80%;
          border-radius: 12px;
          box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
          transition: transform 0.3s ease;">
      <div id="popupText" style="
          margin-top: 20px;
          max-width: 80%;
          color: #fff;
          font-size: 1.2rem;
          text-align: center;
          background-color: rgba(255,255,255,0.1);
          padding: 10px 20px;
          border-radius: 10px;
          font-family: 'Comic Sans MS', sans-serif;">
      </div>
  </div>
</div>

<!-- ===== Twemoji fallback: ONLY if flags aren't supported; ONLY inside .bubble-container/.country-emoji ===== -->
<script src="https://twemoji.maxcdn.com/v/latest/twemoji.min.js" crossorigin="anonymous"></script>
<script>
  function supportsFlagEmoji() {
    const c = document.createElement('canvas');
    const ctx = c.getContext('2d');
    ctx.font = '32px sans-serif';
    const flag = 'üá≤üá∞';
    const wFlag = ctx.measureText(flag).width;
    const wLetters = ctx.measureText('MK').width;
    return wFlag !== wLetters;
  }
  function parseFlagEmojis() {
    // On this page you likely don't have flags,
    // but this safely handles pages that DO (your select page).
    const container = document.querySelector('.bubble-container') || document.body;
    container.querySelectorAll('.country-emoji').forEach(node => {
      if (node.querySelector('img.twemoji-flag')) return;
      twemoji.parse(node, { folder: 'svg', ext: '.svg', className: 'twemoji-flag' });
    });
  }
  document.addEventListener('DOMContentLoaded', function () {
    if (!supportsFlagEmoji()) { parseFlagEmojis(); }
  });
</script>

</body>
</html>
